# 产品架构

<subtitle>从组件与数据流理解 UCloud Sandbox：SDK/CLI、控制面、运行时与模板构建。</subtitle>

---

## 系统架构概览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              用户侧                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                      │
│  │ Python SDK  │  │    CLI      │  │  E2B SDK    │                      │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                      │
│         │                │                │                              │
│         └────────────────┼────────────────┘                              │
│                          ▼                                               │
└─────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                     UCloud Sandbox 控制面                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        API Gateway                               │   │
│  │              (认证 / 路由 / 限流 / 计费)                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│         │                                    │                          │
│         ▼                                    ▼                          │
│  ┌─────────────────┐                 ┌─────────────────┐               │
│  │  沙箱调度服务    │                 │  模板构建服务    │               │
│  │  (生命周期管理)  │                 │  (构建/快照)     │               │
│  └────────┬────────┘                 └────────┬────────┘               │
└───────────┼──────────────────────────────────┼──────────────────────────┘
            │                                  │
            ▼                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          运行时层                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    沙箱运行时集群                                 │   │
│  │         (隔离执行环境 / 文件系统 / 网络 / 进程管理)               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    模板/快照存储                                  │   │
│  │              (镜像仓库 / 快照存储 / 缓存层)                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 两条核心链路

### 链路一：创建并使用沙箱

```
用户代码                    控制面                      运行时
   │                         │                          │
   │ Sandbox.create()        │                          │
   │ ─────────────────────▶  │                          │
   │                         │ 调度沙箱实例              │
   │                         │ ─────────────────────▶   │
   │                         │                          │ 从快照恢复
   │                         │ ◀─────────────────────   │
   │ 返回 Sandbox 对象       │                          │
   │ ◀─────────────────────  │                          │
   │                         │                          │
   │ commands.run() / files.write()                     │
   │ ─────────────────────────────────────────────────▶ │
   │                         │                          │ 执行操作
   │ ◀───────────────────────────────────────────────── │
   │                         │                          │
   │ sandbox.kill()          │                          │
   │ ─────────────────────▶  │                          │
   │                         │ 释放资源                  │
   │                         │ ─────────────────────▶   │
```

### 链路二：构建模板

```
用户代码                    构建服务                    存储
   │                         │                          │
   │ Template.build()        │                          │
   │ ─────────────────────▶  │                          │
   │                         │ 拉取基础镜像              │
   │                         │ ─────────────────────▶   │
   │                         │ ◀─────────────────────   │
   │                         │                          │
   │                         │ 执行构建步骤:             │
   │                         │ - apt_install            │
   │                         │ - pip_install            │
   │                         │ - copy files             │
   │                         │ - run_cmd                │
   │                         │                          │
   │                         │ 执行 start_cmd           │
   │                         │ 等待 ready_cmd 返回 0    │
   │                         │                          │
   │                         │ 生成快照                  │
   │                         │ ─────────────────────▶   │
   │                         │ ◀─────────────────────   │
   │ 返回 BuildInfo          │                          │
   │ ◀─────────────────────  │                          │
```

---

## 核心组件说明

| 组件 | 职责 |
|-----|------|
| **API Gateway** | 认证鉴权、请求路由、限流控制、计费统计 |
| **沙箱调度服务** | 沙箱生命周期管理（创建/连接/暂停/销毁） |
| **模板构建服务** | 执行模板定义、生成快照、管理构建缓存 |
| **沙箱运行时** | 提供隔离执行环境、命令执行、文件系统、网络访问 |
| **模板存储** | 存储模板定义、快照数据、构建缓存 |

---

## 观测与运维

UCloud Sandbox 提供以下观测能力：

| 能力 | 入口 |
|-----|------|
| **构建日志** | `Template.build(on_build_logs=...)` |
| **运行指标** | `sandbox.get_metrics()` |
| **沙箱列表** | `Sandbox.list()` |
| **沙箱信息** | `sandbox.get_info()` |

?> 详见：[指标监控](/agent-sandbox/docs/sdk/sandbox/05-metrics.md)、[构建日志](/agent-sandbox/docs/sdk/template/10-logging.md)

---

## 下一步

- [SDK 快速开始](/agent-sandbox/docs/sdk/00-quick-start.md) - 动手实践
- [模板工作原理](/agent-sandbox/docs/sdk/template/02-how-it-works.md) - 深入快照机制
- [常见问题与排障](/agent-sandbox/docs/troubleshooting/00-overview.md) - 问题诊断
